# æ·±åº¦å­¦ä¹ çš„JavaScriptåŸºç¡€ï¼šä»callbacksåˆ°sync/await

> æœ€è¿‘åœ¨è¯»ä¸€æœ¬ã€ŠåŸºäºæµè§ˆå™¨çš„æ·±åº¦å­¦ä¹ ã€‹ï¼Œä¹¦æ¯”è¾ƒè–„ï¼Œä½†æ˜¯æ¶‰åŠçš„å†…å®¹å¾ˆå¤šï¼Œå› æ­¤åœ¨è¯»çš„è¿‡ç¨‹ä¸­ä¸å¾—ä¸å†æŸ¥é˜…ä¸€äº›èµ„æ–™ï¼Œä»¥åŠ æ·±ç†è§£ã€‚æˆ‘ç›®å‰ä»äº‹çš„æœ¬èŒå·¥ä½œå°±æ˜¯æµè§ˆå™¨ç ”å‘ï¼Œå¯¹äºå‰ç«¯æŠ€æœ¯å¹¶ä¸é™Œç”Ÿã€‚ä½†æ˜¯ä»å‰æ®µæ—¶é—´å¼€å‘å¾®ä¿¡å°ç¨‹åº**è¯†ç‹—å›**çš„è¿‡ç¨‹æ¥çœ‹ï¼Œå¯¹JavaScriptè¿˜æ˜¯æŒæ¡å¾—å¤ªå°‘ï¼Œç‰¹åˆ«æ˜¯å¯¹ä¸€äº›å‰ç«¯æ¡†æ¶ä»¥åŠä¸€äº›æ¯”è¾ƒæ–°çš„JavaScriptè¯­æ³•å’Œç¼–ç¨‹æ¨¡å‹ï¼Œäº†è§£çš„ä¸å¤Ÿã€‚åœ¨ä¿®æ”¹tfjs-coreæºç æ—¶ï¼Œå°±ä½“ä¼šåˆ°è¿™ç§ç—›è‹¦ã€‚å¥½å§ï¼Œæ—¢ç„¶æ— æ³•é¿å¼€ï¼Œé‚£å°±æ­£é¢åˆšå§ã€‚

è¿™ç¯‡æ–‡ç« å°±è°ˆä¸€è°ˆJavaScriptä¸­çš„å¼‚æ­¥ç¼–ç¨‹ã€‚æ–‡ç« å‚è€ƒäº†ç½‘ä¸Šçš„ä¸€äº›èµ„æ–™ï¼Œä¸»è¦ç¤ºä¾‹ä»£ç æ¥è‡ª**Async JavaScript: From Callbacks, to Promises, to Async/Await**ä¸€æ–‡ï¼Œç‚¹å‡»å…¬ä¼—å·çš„é˜…è¯»åŸæ–‡ï¼Œå¯ä»¥è·³è½¬è¯¥æ–‡ç« ã€‚

åœ¨ç¼–å†™å¾®ä¿¡å°ç¨‹åºæ—¶ï¼Œå°±è¢«ä»£ç ä¸­çš„å›è°ƒã€sync/awaitæ•´å¾—ä¸€è„¸æ‡µã€‚å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œå¤šçº¿ç¨‹åº”è¯¥æ˜¯å†ç†Ÿä¸è¿‡çš„æ¦‚å¿µï¼Œç¢°åˆ°è€—æ—¶çš„IOæ“ä½œï¼Œä¸ºäº†ä¸é˜»å¡ç”¨æˆ·ç•Œé¢çš„å“åº”ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ–¹æ³•å¤šåŠæ˜¯é‡‡ç”¨å¤šçº¿ç¨‹ã€‚ç„¶è€Œå¯¹äºå‰ç«¯å¼€å‘æ¥è¯´ï¼Œè¿™ç§æ–¹æ³•æ˜¯ä¸å¯è¡Œçš„ï¼Œå› ä¸ºJavascripté‡‡ç”¨äº†å•çº¿ç¨‹è¿è¡Œæ¨¡å‹ã€‚æ³¨æ„ï¼ŒJavaScriptåªåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œä¸ä»£è¡¨JavaScriptå¼•æ“åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚äº‹å®ä¸Šï¼ŒJavaScriptå¼•æ“æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå•ä¸ªè„šæœ¬åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œå…¶ä»–çº¿ç¨‹éƒ½æ˜¯åœ¨åå°é…åˆã€‚

JavaScriptä¹‹æ‰€ä»¥é‡‡ç”¨å•çº¿ç¨‹ï¼Œè€Œä¸æ˜¯å¤šçº¿ç¨‹ï¼Œè·Ÿå†å²æœ‰å…³ç³»ã€‚JavaScriptä»è¯ç”Ÿèµ·å°±æ˜¯å•çº¿ç¨‹ï¼ŒåŸå› æ˜¯ä¸æƒ³è®©æµè§ˆå™¨å˜å¾—å¤ªå¤æ‚ï¼Œå› ä¸ºå¤šçº¿ç¨‹éœ€è¦å…±äº«èµ„æºã€ä¸”æœ‰å¯èƒ½ä¿®æ”¹å½¼æ­¤çš„è¿è¡Œç»“æœï¼Œå¯¹äºä¸€ç§ç½‘é¡µè„šæœ¬è¯­è¨€æ¥è¯´ï¼Œè¿™å°±å¤ªå¤æ‚äº†ã€‚åæ¥ HTML5 å¼•å…¥äº†web workersï¼Œä¸ºWebå†…å®¹åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ã€‚ä½†è¿™ç§æ–¹æ³•è¿˜æœªè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚

è™½ç„¶JavaScriptè„šæœ¬è¿è¡Œåœ¨å•çº¿ç¨‹ä¸­ï¼Œä½†ä¸€äº›è€—æ—¶æˆ–éœ€è¦ç­‰å¾…çš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡å¼‚æ­¥å›è°ƒæ–¹å¼å®ç°ï¼Œè¿™å°±æ˜¯æœ¬æ–‡å°†è¦è°ˆåˆ°çš„ç¬¬ä¸€ç§æ–¹æ³•ï¼šcallbacksã€‚

### callbacks

åœ¨JavaScriptä¸­ï¼Œcallbacksæ˜¯ä¸€ä¸ªæ¯”è¾ƒå®½æ³›çš„æ¦‚å¿µï¼Œå½“ä½ å°†å‡½æ•°çš„å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œè¿™ä¸ªä½œä¸ºå‚æ•°ä¼ é€’çš„å‡½æ•°å°±ç§°ä½œå›è°ƒå‡½æ•°ã€‚æ¯”å¦‚ï¼š

```javascript
function add (x, y) {
  return x + y
}

function addFive (x, addReference) {
  return addReference(x, 5) // 15 - Press the button, run the machine.
}

addFive(10, add) // 15
```

ä¸Šè¿°ä»£ç ä¸­addå‡½æ•°å°±å¯ä»¥ç§°ä½œå›è°ƒå‡½æ•°ã€‚æ‰€ä»¥è¯´ï¼Œcallabcksé€šå¸¸æœ‰ä¸¤ç§ç”¨é€”ï¼Œä¸€ç§å°±æ˜¯ä½œä¸ºå¤„ç†å‡½æ•°ï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå‰ç«¯ç¨‹åºå‘˜åº”è¯¥å¾ˆç†Ÿæ‚‰å¦‚ä¸‹çš„ç”¨æ³•ï¼š

```javascript
[1,2,3].map((i) => i + 5)

_.filter([1,2,3,4], (n) => n % 2 === 0 );
```

ä»£ç ä¸­ä½¿ç”¨äº†lambdaè¡¨è¾¾å¼ï¼Œç®—æ˜¯ä¸€ç§åŒ¿åå‡½æ•°ã€‚å¦ä¸€ç§ä½¿ç”¨æ–¹æ³•æ›´ä¸ºå¹¿æ³›ï¼Œå»¶è¿Ÿæ‰§è¡ŒæŸä¸ªå‡½æ•°ï¼Œåˆ°ç‰¹å®šçš„æ—¶é—´ã€æˆ–è€…ç­‰åˆ°æ•°æ®ï¼Œæˆ–è€…æ˜¯ç­‰ç”¨æˆ·è¿›è¡Œäº†æ“ä½œï¼š

```javascript
$('#btn').on('click', () =>
  console.log('Callbacks are everywhere')
)

const id = 'tylermcginnis'

$.getJSON({
  url: `https://api.github.com/users/${id}`,
  success: updateUI,
  error: showError,
})
```

è¿™ä¹Ÿæ˜¯æœ¬æ–‡æ‰€è°ˆåˆ°çš„å¼‚æ­¥ç¼–ç¨‹ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­getJSONè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹è¿è¡Œï¼Œæ•°æ®è·å–æˆåŠŸä¹‹åï¼Œä¼šè°ƒç”¨updateUIï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™è°ƒç”¨showErrorã€‚

çœ‹ä¼¼å¼‚æ­¥ç¼–ç¨‹åœ¨JavaScriptä¸­å¾—åˆ°äº†è§£å†³ï¼Œä½†callbacksè¿™ç§æ–¹æ¡ˆå¹¶ä¸å®Œç¾ã€‚ç¬¬ä¸€ä¸ªä¸è¶³ä¹‹å¤„ï¼Œå°±æ˜¯æ‰€è°“çš„â€œå›è°ƒåœ°ç‹±â€ã€‚çœ‹ä»¥ä¸‹ä¸€æ®µä»£ç ï¼š

```javascript
// updateUI, showError, and getLocationURL are irrelevant.
// Pretend they do what they sound like.

const id = 'tylermcginnis'

$("#btn").on("click", () => {
  $.getJSON({
    url: `https://api.github.com/users/${id}`,
    success: (user) => {
      $.getJSON({
        url: getLocationURL(user.location.split(',')),
        success (weather) {
          updateUI({
            user,
            weather: weather.query.results
          })
        },
        error: showError,
      })
    },
    error: showError
  })
})
```

æœ‰æ²¡æœ‰è§‰å¾—æ™•ï¼Œäººé€šå¸¸ä¹ æƒ¯äºçº¿æ€§æ€ç»´ï¼Œé¡ºåºæ‰§è¡Œçš„ä»£ç å®¹æ˜“ç†è§£ï¼Œä½†ä¸Šé¢çš„ä»£ç åµŒå¥—å¤ªå¤šã€‚è¿™è¿˜ä¸æ˜¯åµŒå¥—æœ€å¤šçš„ï¼Œæˆ‘ä¹‹å‰ç¼–å†™å¾®ä¿¡å°ç¨‹åºï¼Œå‚è€ƒçš„ä»£ç æœ‰åµŒå¥—ä¸ƒå…«å±‚çš„ï¼Œçœ‹å¾—ä»¤äººç»æœ›ã€‚è¿™ç§å¤šå±‚åµŒå¥—å®¹æ˜“å‡ºé”™ï¼Œä¹Ÿä¸å¥½è°ƒè¯•ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€äº›æ¨¡å—åŒ–æŠ€æœ¯ï¼Œæ”¹å–„ä»£ç çš„é˜…è¯»æ€§ï¼Œä½†æ— æ³•ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸€é—®é¢˜ã€‚

callbacksçš„å¦ä¸€ä¸ªé—®é¢˜æ˜¯â€œæ§åˆ¶åè½¬â€ï¼Œå½“ä½ çš„ä»£ç è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°å¹¶ä¸æ˜¯ä½ ç¼–å†™çš„ï¼Œä½ å°±å¤±å»äº†æ§åˆ¶æƒã€‚ä¸‡ä¸€ä½ è°ƒç”¨çš„å›è°ƒå‡½æ•°æ‰§è¡Œäº†éå¸¸è€—æ—¶çš„æ“ä½œï¼Œä½†åˆæ²¡æœ‰è€ƒè™‘å¼‚æ­¥ï¼Œä½ ä¹Ÿæ— æ³•æ§åˆ¶ã€‚å¦‚æœä½ è°ƒç”¨çš„æ˜¯jQueryã€lodashä»¥åŠJavaScriptå†…ç½®åº“æ—¶ï¼Œå¯ä»¥æ”¾å¿ƒçš„å‡è®¾å®ƒä»¬ä¼šåŠæ—¶è¿”å›ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¼—å¤šç¬¬ä¸‰æ–¹åº“ï¼Œä½ è¿˜ä¼šè¿™ä¹ˆæ”¾å¿ƒå—ï¼Ÿ ç¬¬ä¸‰æ–¹åº“å¯èƒ½æœ‰æ„æˆ–æ— æ„ç ´åäº†å®ƒä»¬ä¸å›è°ƒçš„äº¤äº’æ–¹å¼ã€‚

### Promise

ä¸ºäº†è§£å†³callbacksçš„ç§ç§ä¸è¶³ï¼Œä¸€äº›èªæ˜äººæå‡ºäº†Promiseçš„æ€è·¯ã€‚ä¸ºäº†ç†è§£è¿™ä¸€æ–¹æ¡ˆï¼Œæˆ‘ä»¬å…ˆä»æ—¥å¸¸ç”Ÿæ´»çš„ä¸€ä¸ªåœºæ™¯å‡ºå‘ï¼Œä½œä¸ºä¸€åéƒ½å¸‚äººï¼Œä¼°è®¡å¤§å®¶éƒ½æœ‰å»é¤é¦†ç­‰ä½ç½®çš„ç»å†å§ï¼æœ€å‚»çš„ä¸€ç§æ–¹å¼å°±æ˜¯å«å·ï¼Œè¿™ä¹Ÿæ˜¯å¤§å¤šæ•°é¤å…é‡‡ç”¨çš„æ–¹æ³•ï¼Œå¤§å®¶éƒ½æ’åœ¨é¤å…çš„é—¨å£ï¼Œæœ‰äº†ç©ºä½å†æŒ‰å…ˆæ¥ååˆ°çš„é¡ºåºå°±é¤ã€‚åæ¥æœ‰çš„å•†å®¶åšäº†æ”¹è¿›ï¼Œç•™ä¸‹ç”µè¯å·ç ï¼Œå¿«åˆ°æœ‰ä½å­çš„æ—¶å€™ï¼Œé€šè¿‡çŸ­ä¿¡æˆ–è€…å¾®ä¿¡é€šçŸ¥ã€‚åœ¨ç­‰å¾…çš„è¿™æ®µæ—¶é—´ï¼Œå®¢æˆ·å¯ä»¥åœ¨é™„è¿‘é€›é€›ï¼Œåªè¦ä¸æ˜¯ç¦»å¾—å¤ªè¿œã€‚ä»”ç»†æƒ³æƒ³ï¼Œç¬¬ä¸€ç§æ–¹å¼ç±»ä¼¼äºç¼–ç¨‹ä¸­çš„åŒæ­¥æ¨¡å‹ï¼Œå®¢æˆ·éœ€è¦ä¸€ç›´æ­»ç­‰ï¼Œç¬¬äºŒç§æ–¹å¼ç±»ä¼¼äºå‰é¢çš„å›è°ƒæ¨¡å‹ã€‚å›è°ƒæ¨¡å¼çš„é—®é¢˜åœ¨å“ªï¼Ÿæƒ³æƒ³æˆ‘ä»¬å¹³å¸¸æ”¶åˆ°çš„æ¨é”€ç”µè¯ï¼Œæœ‰æ²¡æœ‰å¯èƒ½å°±æ˜¯ä½ åœ¨ä¸€æ¬¡ä¸ç»æ„çš„ç•™ä¸‹ç”µè¯å·ç æ‹›æ¥çš„ï¼Ÿæˆ‘ä»¬æ— æ³•ä¿è¯æ¯ä¸ªé¤å…éƒ½èƒ½æŒ‰è‰¯å¿ƒåŠäº‹ï¼Œåªç”¨äºè¿™æ¬¡çš„é¤å…ç­‰ä½é€šçŸ¥ã€‚

ä¸¤ç§æ–¹å¼éƒ½å­˜åœ¨ä¸è¶³ï¼Œäºæ˜¯æœ‰äººæƒ³å‡ºäº†ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œå°±æ˜¯å¦‚ä¸‹å›¾æ‰€ç¤ºçš„èœ‚é¸£å™¨ï¼š

![image](https://raw.githubusercontent.com/mogoweb/mywritings/master/book_wechat/201912/images/js_async_01.png)

è¿™ç§å°è£…å¤‡åœ¨å›½å†…ä¸å¤šè§ï¼Œåæ­£æˆ‘æ˜¯æ²¡è§è¿‡ã€‚ä¸è¿‡ç®€å•è§£é‡Šä¸€ä¸‹ï¼Œå¾ˆå®¹æ˜“æ˜ç™½å…¶å·¥ä½œåŸç†ã€‚å½“èœ‚é¸£å™¨å—¡å—¡ä½œå“å¹¶å‘å…‰æ—¶ï¼Œè¡¨æ˜å·²ç»æœ‰æ¡Œå­ç©ºå‡ºæ¥ã€‚å®é™…ä¸Šï¼Œèœ‚é¸£å™¨å°†å¤„äºä¸‰ç§ä¸åŒçŠ¶æ€ä¹‹ä¸€ï¼šå¾…å¤„ç†ã€æ¥å—æˆ–æ‹’ç»ã€‚

* **å¾…å¤„ç†**æ˜¯é»˜è®¤çš„åˆå§‹çŠ¶æ€ã€‚å½“ä»–ä»¬ç»™æ‚¨èœ‚é¸£å™¨æ—¶ï¼Œå®ƒå°±å¤„äºè¿™ç§çŠ¶æ€ã€‚

* èœ‚é¸£å™¨é—ªçƒè¡¨æ˜æ‚¨çš„æ¡Œå­å‡†å¤‡å°±ç»ªï¼Œèœ‚é¸£å™¨å¤„äº**æ¥å—**çŠ¶æ€ã€‚

* å‡ºç°é—®é¢˜æ—¶ï¼ˆä¹Ÿè®¸é¤å…å¿«è¦å…³é—¨äº†ï¼Œæˆ–è€…ä»–ä»¬å¿˜äº†æœ‰äººæŠŠé¤å…ç§Ÿäº†ä¸€æ™šï¼‰ï¼Œèœ‚é¸£å™¨å°†å¤„äº**æ‹’ç»**çŠ¶æ€ã€‚

åœ¨ç°å®ä¸­ï¼Œè¿™ç§æ–¹æ¡ˆæœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦è€ƒè™‘ï¼Œèœ‚é¸£å™¨é€šè®¯èŒƒå›´å¤šå¹¿ï¼ˆä¼šä¸ä¼šèµ°å¤ªè¿œï¼Œæ”¶ä¸åˆ°ä¿¡å·ï¼Ÿï¼‰ã€å®¢äººæ‹¿äº†èœ‚é¸£å™¨ä¸å½’è¿˜æ€ä¹ˆåŠï¼Ÿä½†æ˜¯å°†è¿™ç§æ–¹æ¡ˆç”¨åœ¨è§£å†³JavaScriptä¸­çš„å¼‚æ­¥é—®é¢˜ï¼Œå°±ä¸å­˜åœ¨ä¸Šè¿°é—®é¢˜ï¼Œåˆèƒ½å¾ˆå¥½çš„è§£å†³æ§åˆ¶æƒåè½¬é—®é¢˜ï¼Œè¿™å°±æ˜¯JavaScriptä¸­çš„Promiseã€‚

Promiseæœ‰ä¸‰ç§çŠ¶æ€ï¼špending, fulfilledå’Œrejectedã€‚å¦‚æœå¼‚æ­¥è¯·æ±‚ä»åœ¨è¿›è¡Œä¸­ï¼Œåˆ™Promiseçš„çŠ¶æ€å°†ä¸ºpendingã€‚å¦‚æœå¼‚æ­¥è¯·æ±‚å·²æˆåŠŸå®Œæˆï¼Œåˆ™Promiseå°†å˜ä¸ºfulfilledçŠ¶æ€ã€‚å¦‚æœå¼‚æ­¥è¯·æ±‚å¤±è´¥ï¼Œåˆ™Promiseå°†å˜ä¸ºrejectedçŠ¶æ€ã€‚æ˜¯ä¸æ˜¯å’Œå‰é¢ç”¨äºè§£å†³é¤å…ç­‰ä½é—®é¢˜çš„èœ‚é¸£å™¨å¾ˆåƒï¼Ÿ

äº†è§£Promiseå­˜åœ¨çš„åŸå› ä»¥åŠå®ƒä»¬å¯èƒ½å¤„äºçš„ä¸åŒçŠ¶æ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š

* å¦‚ä½•åˆ›å»ºPromiseï¼Ÿ
* å¦‚ä½•æ›´æ”¹Promiseçš„çŠ¶æ€ï¼Ÿ
* å½“PromiseçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‚¨è¯¥å¦‚ä½•ç›‘å¬ï¼Ÿ

#### åˆ›å»ºPromise

ç¬¬ä¸€ä¸ªé—®é¢˜å¾ˆå¥½å›ç­”ï¼Œç›´æ¥newä¸€ä¸ªPromiseçš„å®ä¾‹å³å¯ï¼š

```javascript
const promise = new Promise()
```

æ³¨æ„å¹¶éæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒPromiseå¯¹è±¡ï¼Œè‡ª Chrome 32ã€Opera 19ã€Firefox 29ã€Safari 8 å’Œ Microsoft Edge èµ·ï¼Œpromise é»˜è®¤å¯ç”¨ï¼Œæ‰€ä»¥ä½¿ç”¨å‰è¯·ç¡®è®¤ä½ æ‰€ä½¿ç”¨çš„æµè§ˆå™¨å†…æ ¸ã€‚

#### ä¿®æ”¹Promiseçš„çŠ¶æ€

Promiseæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³ï¼ˆå›è°ƒï¼‰å‡½æ•°ã€‚è¯¥å‡½æ•°å°†ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼šresolveå’Œrejectã€‚

* resolve: å°†PromiseçŠ¶æ€ä¿®æ”¹ä¸ºfulfilledçš„å‡½æ•°ã€‚

* reject: å°†PromiseçŠ¶æ€ä¿®æ”¹ä¸ºrejectedçš„å‡½æ•°ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨setTimeoutç­‰å¾…2ç§’ï¼Œç„¶åè°ƒç”¨resolveï¼ŒPromiseçŠ¶æ€å°†å˜ä¸ºfulfilledã€‚

```javascript
const promise = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve() // Change status to 'fulfilled'
  }, 2000)
})
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åˆ›å»ºPromiseåç«‹å³è¾“å‡ºPromiseå€¼ï¼Œç„¶ååœ¨å¤§çº¦2ç§’é’Ÿåresolveè¢«è°ƒç”¨åå†æ¬¡è¾“å‡ºPromiseå€¼ï¼Œæ¥è§‚å¯Ÿåˆ°è¿™ç§å˜åŒ–ã€‚

![image](https://raw.githubusercontent.com/mogoweb/mywritings/master/book_wechat/201912/images/js_async_02.gif)

æ³¨æ„åˆ°æ²¡æœ‰ï¼ŒPromiseä»**pending**çŠ¶æ€å˜ä¸º**resolved**ã€‚

#### ç›‘å¬PromiseçŠ¶æ€å˜åŒ–

è¿™æ˜¯æœ€é‡è¦çš„é—®é¢˜ã€‚å¦‚æœçŠ¶æ€æ›´æ”¹åæˆ‘ä»¬ä¸çŸ¥é“å¦‚ä½•åšï¼Œé‚£æ¯«æ— ç”¨å¤„ã€‚

åˆ›å»ºæ–°çš„Promiseæ—¶ï¼Œå®é™…ä¸Šåªæ˜¯åœ¨åˆ›å»ºä¸€ä¸ªæ™®é€šçš„JavaScriptå¯¹è±¡ã€‚è¯¥å¯¹è±¡å¯ä»¥è°ƒç”¨thenå’Œcatchè¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ¥å—ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ã€‚å½“Promiseçš„çŠ¶æ€å˜ä¸ºfulfilledæ—¶ï¼Œä¼ é€’ç»™.thençš„å‡½æ•°å°†è¢«è°ƒç”¨ã€‚å½“ä¸€ä¸ªPromiseçš„çŠ¶æ€æ›´æ”¹ä¸ºrejectedæ—¶ï¼Œå°†è°ƒç”¨ä¼ é€’ç»™.catchçš„å‡½æ•°ã€‚

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚æˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨setTimeoutä¸¤ç§’é’Ÿï¼ˆ2000æ¯«ç§’ï¼‰åå°†PromiseçŠ¶æ€å˜ä¸ºfulfilledã€‚

```javascript
function onSuccess () {
  console.log('Success!')
}

function onError () {
  console.log('ğŸ’©')
}

const promise = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve()
  }, 2000)
})

promise.then(onSuccess)
promise.catch(onError)
```

å°è¯•ç€è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œå¤§çº¦2ç§’é’Ÿåï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­å¯çœ‹åˆ°â€œSuccessï¼â€ã€‚

è¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿé¦–å…ˆï¼Œå½“æˆ‘ä»¬åˆ›å»ºPromiseæ—¶ï¼Œæˆ‘ä»¬åœ¨çº¦2000æ¯«ç§’åè°ƒç”¨äº†resolveï¼Œè¿™å°†Promiseçš„çŠ¶æ€æ›´æ”¹ä¸ºfulfilledã€‚å…¶æ¬¡ï¼Œæˆ‘ä»¬å°†onSuccesså‡½æ•°ä¼ é€’ç»™promisesçš„.thenæ–¹æ³•ã€‚è¿™æ ·åšï¼Œæˆ‘ä»¬å‘Šè¯‰äº†Promiseï¼Œå½“Promiseçš„çŠ¶æ€æ›´æ”¹ä¸ºfulfilledæ—¶è°ƒç”¨onSuccessï¼Œå®ƒåœ¨å¤§çº¦2000æ¯«ç§’åæ‰§è¡Œã€‚

å†æ¥çœ‹çœ‹rejectedæƒ…å†µä¸‹çš„ä»£ç ï¼š

```javascript
function onSuccess () {
  console.log('Success!')
}

function onError () {
  console.log('ğŸ’©')
}

const promise = new Promise((resolve, reject) => {
  setTimeout(() => {
    reject()
  }, 2000)
})

promise.then(onSuccess)
promise.catch(onError)
```

è¿™ç§æƒ…å†µä¸‹ï¼ŒonErrorå°†ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸º2000æ¯«ç§’åï¼Œrejectè¢«è°ƒç”¨äº†ã€‚

---

å›å¤´å†çœ‹çœ‹å‰é¢çš„å¼‚æ­¥ä»£ç ï¼š

```javascript
function getUser(id, onSuccess, onFailure) {
  $.getJSON({
    url: `https://api.github.com/users/${id}`,
    success: onSuccess,
    error: onFailure
  })
}

function getWeather(user, onSuccess, onFailure) {
  $.getJSON({
    url: getLocationURL(user.location.split(',')),
    success: onSuccess,
    error: onFailure,
  })
}

$("#btn").on("click", () => {
  getUser("tylermcginnis", (user) => {
    getWeather(user, (weather) => {
      updateUI({
        user,
        weather: weather.query.results
      })
    }, showError)
  }, showError)
})
```

ç”¨Promiseçš„æ–¹å¼è¯¥å¦‚ä½•æ”¹å†™å‘¢ï¼Ÿé¦–å…ˆçœ‹çœ‹getUserè¿™ä¸ªå‡½æ•°çš„æ”¹å†™ï¼š

```javascript
function getUser(id) {
  return new Promise((resolve, reject) => {
    $.getJSON({
      url: `https://api.github.com/users/${id}`,
      success: resolve,
      error: reject
    })
  })
}
```

æ³¨æ„åˆ°æ²¡æœ‰ï¼ŒgetUserçš„å‚æ•°æœ‰æ‰€å˜åŒ–ï¼Œä»…æ¥æ”¶IDï¼Œä¸å†éœ€è¦å…¶ä»–ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä¿è¯ä¸ä¼šå‘ç”Ÿ**æ§åˆ¶åè½¬**ã€‚å¦‚æœè¯·æ±‚æˆåŠŸï¼Œåˆ™å°†è°ƒç”¨resolveï¼›å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™å°†è°ƒç”¨rejectã€‚

åŒæ ·çš„æ–¹å¼æ”¹å†™getWetherå‡½æ•°ï¼š

```javascript
function getWeather(user) {
  return new Promise((resolve, reject) => {
    $.getJSON({
      url: getLocationURL(user.location.split(',')),
      success: resolve,
      error: reject,
    })
  })
}
```

æ¥ç€æ”¹å†™æŒ‰é’®ç‚¹å‡»å¤„ç†ï¼š

```javascript
$("#btn").on("click", () => {
  const userPromise = getUser('tylermcginnis')

  userPromise.then((user) => {
    const weatherPromise = getWeather(user)
    weatherPromise.then((weather) => {
      updateUI({
        user,
        weather: weather.query.results
      })
    })

    weatherPromise.catch(showError)
  })

  userPromise.catch(showError)
})
```

ä»£ç çš„é€»è¾‘å°±æ˜¯æ ¹æ®idè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ç”¨æˆ·æ‰€åœ¨çš„åœ°ç†ä½ç½®è·å–å¤©æ°”ä¿¡æ¯ï¼Œæœ€åæ›´æ–°åˆ°ç”¨æˆ·ç•Œé¢ä¸Šã€‚

æ•´æ¡é€»è¾‘å°±åƒæ˜¯ä¸€ä¸ªçº¿æ€§å¤„ç†è¿‡ç¨‹ï¼Œäº‹å®ä¸Šï¼Œé€šè¿‡Promiseçš„é“¾å¼ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»£ç å†™å¾—æ›´ç´§å‡‘ä¸€äº›ã€‚

```javascript
$("#btn").on("click", () => {
  getUser("tylermcginnis")
    .then(getWeather)
    .then((weather) => {
      // We need both the user and the weather here.
      // Right now we just have the weather
      updateUI() // ????
    })
    .catch(showError)
})
```

ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥å¾ˆç®€ç»ƒï¼Œä½†å®é™…ä¸Šéšè—ç€ä¸€ä¸ªé—®é¢˜ã€‚åœ¨ç¬¬äºŒä¸ª.thenä¸­ï¼Œæˆ‘ä»¬è¦è°ƒç”¨updateUIã€‚é—®é¢˜æ˜¯æˆ‘ä»¬éœ€è¦åŒæ—¶ç»™updateUIä¼ é€’ç”¨æˆ·å’Œå¤©æ°”ã€‚ä½†ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åªä¼ é€’äº†å¤©æ°”ä¿¡æ¯ï¼Œè€Œæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼æ‰¾åˆ°ä¸€ç§å®ç°æ–¹æ³•ï¼Œä»¥ä¾¿åœ¨getWeatherè¿”å›çš„Promiseåœ¨resolveæ—¶ï¼Œç”¨æˆ·å’Œå¤©æ°”éƒ½å¯ä»¥ä¼ é€’ã€‚

è§£å†³é—®é¢˜çš„å…³é”®åœ¨äºï¼Œresolveåªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼ é€’ç»™å®ƒçš„ä»»ä½•å‚æ•°éƒ½å°†ä¼ é€’ç»™ç»™.thençš„å‡½æ•°ã€‚è¿™æ„å‘³ç€åœ¨getWeatherå†…éƒ¨ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨è‡ªå·±çš„resolveæ–¹æ³•ï¼Œåˆ™å¯ä»¥å°†å¤©æ°”å’Œç”¨æˆ·ä¼ é€’ç»™å®ƒã€‚è¿™æ ·ï¼Œé“¾ä¸­çš„ç¬¬äºŒä¸ª.thenæ–¹æ³•å°†åŒæ—¶æ¥æ”¶ç”¨æˆ·å’Œå¤©æ°”ä½œä¸ºå‚æ•°ã€‚

```javascript
function getWeather(user) {
  return new Promise((resolve, reject) => {
    $.getJSON({
      url: getLocationURL(user.location.split(',')),
      success(weather) {
        resolve({ user, weather: weather.query.results })
      },
      error: reject,
    })
  })
}

$("#btn").on("click", () => {
  getUser("tylermcginnis")
    .then(getWeather)
    .then((data) => {
      // Now, data is an object with a
      // "weather" property and a "user" property.

      updateUI(data)
    })
    .catch(showError)
})
```

æ¯”è¾ƒä»¥ä¸‹Callbackså’ŒPromiseçš„å®ç°ä»£ç ï¼Œæ˜¯ä¸æ˜¯Promiseæ›´å®¹æ˜“ç†è§£ï¼Ÿ

```javascript
// Callbacks ğŸš«
getUser("tylermcginnis", (user) => {
  getWeather(user, (weather) => {
    updateUI({
      user,
      weather: weather.query.results
    })
  }, showError)
}, showError)


// Promises âœ…
getUser("tylermcginnis")
  .then(getWeather)
  .then((data) => updateUI(data))
  .catch(showError);
```

### async/await

ä¸Šé¢çš„Promiseæ–¹æ¡ˆè§£å†³äº†Callbacksçš„ä¸¤å¤§é‡è¦ç¼ºé™·ï¼Œä½†è¿˜å­˜åœ¨ä¸è¶³ï¼Œæˆ‘ä»¬éœ€è¦å°†ç”¨æˆ·æ•°æ®ä»ç¬¬ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ä¸€ç›´ä¼ é€’åˆ°æœ€åä¸€ä¸ª.thenã€‚è¿™ä½¿å¾—æˆ‘ä»¬ä¿®æ”¹getWeatherå‡½æ•°ï¼Œä½¿å…¶å¯ä»¥ä¼ é€’ç”¨æˆ·ã€‚

æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥è®©æˆ‘ä»¬ä»¥ç¼–å†™åŒæ­¥ä»£ç çš„æ–¹å¼ç¼–å†™å¼‚æ­¥ä»£ç å‘¢ï¼Ÿå‡å¦‚æˆ‘ä»¬ä»¥åŒæ­¥æ–¹å¼å®ç°ä¸Šè¿°çš„åŠŸèƒ½ï¼Œå¤§æ¦‚å†™æ³•å¦‚ä¸‹ï¼š

```javascript
$("#btn").on("click", () => {
  const user = getUser('tylermcginnis')
  const weather = getWeather(user)

  updateUI({
    user,
    weather,
  })
})
```

å¦‚ä½•è®©Javascriptå¼•æ“çŸ¥é“è¿™é‡ŒgetUserå’ŒgetWeatherå®é™…ä¸Šæ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•å‘¢ï¼Ÿè¿™æ—¶å°±è¯¥async/awaitç™»åœºäº†ã€‚

```javascript

$("#btn").on("click", async () => {
  const user = await getUser('tylermcginnis')
  const weather = await getWeather(user.location)

  updateUI({
    user,
    weather,
  })
})
```

é¦–å…ˆï¼Œå‡½æ•°å‰çš„asyncä¿®é¥°å‘Šè¯‰å¼•æ“ï¼Œè¯¥å‡½æ•°ä¸­å­˜åœ¨å¼‚æ­¥è°ƒç”¨ã€‚å…¶æ¬¡ï¼Œä»£ç ä¸­çš„awaitè¿™è¡¨ç¤ºè¿™ä¸ªè°ƒç”¨æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œå°†è¿”å›ä¸€ä¸ªPromiseã€‚åœ¨awaitçš„åœ°æ–¹ï¼Œä»£ç å°†ç­‰å¾…ï¼Œç›´åˆ°å¼‚æ­¥è°ƒç”¨è¿”å›Promiseã€‚

å‡½æ•°å‰åŠ ä¸Šasyncï¼Œä»£è¡¨å‡½æ•°å°†è¿”å›ä¸€ä¸ªPromiseï¼Œå³ä½¿åƒä¸‹é¢è¿™æ ·çš„ç©ºå‡½æ•°ï¼Œä¹Ÿä¼šéšå¼è¿”å›ä¸€ä¸ªPromiseï¼š

```javascript
async function getPromise(){}

const promise = getPromise()
```

å¦‚æœasyncå‡½æ•°è¿”å›äº†å€¼å‘¢ï¼Ÿå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼Œè¯¥å€¼å°†å°è£…åˆ°Promiseä¸­ï¼š

```javascript
async function add (x, y) {
  return x + y
}

add(2,3).then((result) => {
  console.log(result) // 5
})
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œawaitåªèƒ½ç”¨åœ¨asyncå‡½æ•°ä¸­ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼Œä¼šå‡ºé”™ï¼š

```javascript
$("#btn").on("click", () => {
  const user = await getUser('tylermcginnis') // SyntaxError: await is a reserved word
  const weather = await getWeather(user.location) // SyntaxError: await is a reserved word

  updateUI({
    user,
    weather,
  })
})
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“asyncåŠ åˆ°å‡½æ•°æ—¶ï¼Œä¼šäº§ç”Ÿä¸¤ç§ç»“æœï¼š

* ä½¿å‡½æ•°æœ¬èº«è¿”å›ï¼ˆæˆ–åŒ…è£…è¿”å›çš„å†…å®¹ï¼‰ä¸€ä¸ªpromise
* å¯ä»¥åœ¨å…¶ä¸­ä½¿ç”¨awaitã€‚

### å°ç»“

å¥½äº†ï¼Œå…³äºJavaScriptä¸­çš„å¼‚æ­¥ç¼–ç¨‹å°±æ¢è®¨åˆ°è¿™å„¿ï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬å¹³å¸¸é‡‡ç”¨çš„Pythonã€Javaæˆ–C++è¯­è¨€ä¸å¤ªä¸€æ ·ã€‚æœ‰äººè¯´ï¼Œå­¦ä¸€é—¨è¯­è¨€ï¼Œå®é™…ä¸Šæ˜¯å­¦ä¹ ä¸€ç§ç¼–ç¨‹æ€è·¯ï¼Œä½ æ²¡æœ‰æƒ³åˆ°JavaScriptä¼šç”¨è¿™ç§æ–¹å¼æ¥è§£å†³å¼‚æ­¥ç¼–ç¨‹å§ï¼è¿™ç¯‡æ–‡ç« ä½ çœ‹äº†ä¹‹åï¼Œæ˜¯é†é†çŒé¡¶ï¼Œè¿˜æ˜¯æ›´åŠ è¿·ç³Šå‘¢ï¼Ÿæ¬¢è¿ç•™è¨€æ¢è®¨ã€‚

![images](https://raw.githubusercontent.com/mogoweb/mywritings/master/book_wechat/common_images/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7_%E5%85%B3%E6%B3%A8%E4%BA%8C%E7%BB%B4%E7%A0%81.png)